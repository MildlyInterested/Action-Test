name: Extract Data from Appended File and Update Issue

on:
  issues:
    types: [opened]

jobs:
  extract-data-and-update-issue:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Extract Data
        run: |
          set -x
          # Get the issue number
          ISSUE_NUMBER=$(echo "${{ github.event.issue.number }}")
          # Get the contents of the appended file
          # Get the URL of the first file linked in the issue
          FILE_URL=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "${{ github.api_url }}/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}" | jq -r '.body | match("(?i)https://github.com/[^/]+/[^/]+/files/[0-9]+/[^)]+") | .string')
          # Download the file
          APPENDED_FILE_CONTENTS=$(curl -s -L -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "$FILE_URL" | tee /dev/stderr)
          # Parse the contents of the appended file to extract the required data
          Arma_Version=$(echo "$APPENDED_FILE_CONTENTS" | awk '/^Type:/{t=$0} /^Build:/{b=$0} /^Version:/{print t"\n"b"\n"$0}' | grep -oP '\d+\.\d+\.\d+')
          ACE_Version=$(echo "$APPENDED_FILE_CONTENTS" | grep -oP 'Advanced Combat Environment \K\d+\.\d+\.\d+')
          CBA_Version=$(echo "$APPENDED_FILE_CONTENTS" | grep -oP 'Community Base Addons v\K\d+\.\d+\.\d+')
          KAT_Version=$(echo "$APPENDED_FILE_CONTENTS" | grep -oP 'kat_main\.pbo - \K\d+\.\d+\.\d+\.\d+')
          Modlist=$(echo "$APPENDED_FILE_CONTENTS" | sed -n '/----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------/,/==========================================================================================================================================================================================================/ {/----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------/!{/==========================================================================================================================================================================================================/!p}}' | sed 's/^[0-9]\{2\}:[0-9]\{2\}:[0-9]\{2\}//' | awk -F '|' '{print $1}')
          # Update the issue with the extracted data
          # Comment on the issue with the extracted data
          curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" -X POST "${{ github.api_url }}/repos/${{ github.repository }}/issues/${ISSUE_NUMBER}/comments" -H "Accept: application/vnd.github.v3+json" -d "{\"body\":\"Arma Version: ${Arma_Version}\nACE Version: ${ACE_Version}\nCBA Version: ${CBA_Version}\nKAT Version: ${KAT_Version}\nModlist: ${Modlist}\"}"